{% extends 'base.html' %}
{% load static %}
{% load bootstrap5 %}

{% block title %}Recipient Compatibility Form{% endblock title %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
        <li class="breadcrumb-item"><a
                href="{% url 'recipientpage' %}">Recipient</a></li>
        <li class="breadcrumb-item active" aria-current="page">Compatibility
            Form</li>
    </ol>
</nav>
{% endblock breadcrumb %}

{% block content %}
{% if messages %}
<div class="already-checked-container">
    <div class="already-checked-content">
        <div class="already-checked-icon">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <h2>Compatibility Check Already Completed</h2>
        <p>You have already made a compatibility assessment. One prediction per
            user is allowed to ensure accurate results.</p>
        <div class="already-checked-actions">
            <a href="{% url 'recipientprictiction' %}" class="btn btn-primary">
                <i class="fas fa-eye"></i>
                View My Results
            </a>
            <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                <i class="fas fa-home"></i>
                Go to Home Page
            </a>
        </div>
    </div>
</div>
{% else %}
<section class="form-section">
    <div class="container">
        <div class="form-container">
            <div class="form-header">
                <h1 class="form-title">Recipient Compatibility Assessment</h1>
                <p class="form-subtitle">Complete this comprehensive form to
                    assess your organ transplant compatibility</p>
            </div>

            <form id="recipient-form" class="modern-form"
                action="javascript:void(0);" method="post"
                onsubmit="return false;">
        {% csrf_token %}

                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Basic Information</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Medical Details</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Transplant Info</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Review & Submit</div>
                    </div>
                </div>

        <!-- Stage 1: Basic Demographics and Physical Attributes -->
                <div class="form-stage active" id="stage-1">
                    <div class="stage-header">
                        <h3>Basic Demographics and Physical Attributes</h3>
                        <p>Please provide your basic personal and physical
                            information</p>
                    </div>

                    <div class="form-grid grid-2">
                        <div class="form-group">
                            <label for="age" class="form-label">Age (in
                    years)</label>
                            <input type="number" class="form-input" id="age"
                                name="age" required placeholder="e.g., 30">
            </div>

                        <div class="form-group">
                            <label for="gender"
                                class="form-label">Gender</label>
                            <select class="form-select" required id="gender"
                                name="gender">
                    <option value>Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="blood_type" class="form-label">Blood
                                Type</label>
                            <select class="form-select" id="blood_type" required
                    name="blood_type">
                    <option value>Select...</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="AB">AB</option>
                    <option value="O">O</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="rh_factor" class="form-label">Rh
                                Factor</label>
                            <select class="form-select" id="rh_factor" required
                    name="rh_factor">
                    <option value>Select...</option>
                                <option value="positive">Positive (+)</option>
                                <option value="negative">Negative (-)</option>
                </select>
            </div>

                        <div class="form-group">
                <label for="height_cm" class="form-label">Height (in
                    centimeters)</label>
                            <input type="number" class="form-input"
                                id="height_cm" name="height_cm" required
                                placeholder="e.g., 175">
            </div>

                        <div class="form-group">
                <label for="weight_kg" class="form-label">Weight (in
                    kilograms)</label>
                            <input type="number" class="form-input"
                                id="weight_kg" name="weight_kg" required
                                placeholder="e.g., 70">
            </div>

                        <div class="form-group">
                <label for="bmi" class="form-label">Body Mass Index
                    (BMI)</label>
                            <input type="number" step="0.1" class="form-input"
                                id="bmi" name="bmi" required
                                placeholder="e.g., 24.2">
                        </div>
            </div>

                    <div class="form-actions">
                <button type="button" class="btn btn-primary"
                            onclick="nextStage()">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
            </div>
        </div>

        <!-- Stage 2: Medical History and Current Condition -->
                <div class="form-stage" id="stage-2">
                    <div class="stage-header">
                        <h3>Medical History and Current Condition</h3>
                        <p>Please provide detailed medical information for
                            accurate assessment</p>
                    </div>

                    <div class="form-grid grid-2">
                        <div class="form-group">
                            <label for="wait_list_days"
                                class="form-label">Waitlist Days</label>
                            <input type="number" class="form-input"
                                id="wait_list_days" name="wait_list_days"
                                required placeholder="e.g., 1180">
            </div>

                        <div class="form-group">
                            <label for="medical_urgency_score"
                                class="form-label">Medical Urgency Score</label>
                            <input type="number" step="0.1" class="form-input"
                                id="medical_urgency_score"
                                name="medical_urgency_score" required
                    placeholder="e.g., 8.5">
            </div>

                        <div class="form-group">
                            <label for="hemoglobin"
                                class="form-label">Hemoglobin (g/dL)</label>
                            <input type="number" step="0.1" class="form-input"
                    id="hemoglobin" name="hemoglobin" required
                    placeholder="e.g., 13.5">
            </div>

                        <div class="form-group">
                            <label for="wbc_count" class="form-label">White
                                Blood Cell (WBC) Count (cells/µL)</label>
                            <input type="number" class="form-input"
                                id="wbc_count" name="wbc_count" required
                                placeholder="e.g., 7000">
            </div>

                        <div class="form-group">
                            <label for="platelet_count"
                                class="form-label">Platelet Count
                    (cells/µL)</label>
                            <input type="number" class="form-input"
                                id="platelet_count" name="platelet_count"
                                required placeholder="e.g., 250000">
            </div>

                        <div class="form-group">
                            <label for="creatinine"
                                class="form-label">Creatinine (mg/dL)</label>
                            <input type="number" step="0.1" class="form-input"
                    id="creatinine" required name="creatinine"
                    placeholder="e.g., 1.2">
            </div>

                        <div class="form-group">
                            <label for="alt" class="form-label">Alanine
                                Aminotransferase (ALT) (U/L)</label>
                            <input type="number" step="0.1" class="form-input"
                                id="alt" name="alt" required
                                placeholder="e.g., 25">
                        </div>

                        <div class="form-group">
                            <label for="ast" class="form-label">Aspartate
                                Aminotransferase (AST) (U/L)</label>
                            <input type="number" step="0.1" class="form-input"
                                id="ast" name="ast" required
                                placeholder="e.g., 30">
            </div>
            </div>

                    <div class="form-actions">
                <button type="button" class="btn btn-secondary"
                            onclick="previousStage()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                <button type="button" class="btn btn-primary"
                            onclick="nextStage2()">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
            </div>
        </div>

        <!-- Stage 3: Transplant-Specific Information -->
                <div class="form-stage" id="stage-3">
                    <div class="stage-header">
                        <h3>Transplant-Specific Information</h3>
                        <p>Please provide transplant-specific details for
                            compatibility assessment</p>
                    </div>

                    <div class="form-grid grid-2">
                        <div class="form-group">
                            <label for="diabetes"
                                class="form-label">Diabetes</label>
                            <select class="form-select" id="diabetes" required
                    name="diabetes">
                    <option value>Select...</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

                        <div class="form-group">
                <label for="hypertension"
                    class="form-label">Hypertension</label>
                            <select class="form-select" id="hypertension"
                    required name="hypertension">
                    <option value>Select...</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="previous_transplant"
                                class="form-label">Previous Transplant</label>
                            <select class="form-select" id="previous_transplant"
                    required name="previous_transplant">
                    <option value>Select...</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="dialysis_status"
                                class="form-label">Dialysis Status</label>
                            <select class="form-select" id="dialysis_status"
                    required name="dialysis_status">
                    <option value>Select...</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="required_organ"
                                class="form-label">Required Organ</label>
                            <select class="form-select" id="required_organ"
                    required name="required_organ">
                    <option value>Select...</option>
                                <option value="Kidney">Kidney</option>
                                <option value="Liver">Liver</option>
                                <option value="Heart">Heart</option>
                                <option value="Lungs">Lungs</option>
                                <option value="Pancreas">Pancreas</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="antibody_screen"
                                class="form-label">Antibody Screen</label>
                            <select class="form-select" id="antibody_screen"
                    required name="antibody_screen">
                    <option value>Select...</option>
                                <option value="Positive">Positive</option>
                                <option value="Negative">Negative</option>
                </select>
            </div>

                        <div class="form-group">
                            <label for="pra_score" class="form-label">Panel
                                Reactive Antibody (PRA) Score (%)</label>
                            <input type="number" step="0.1" class="form-input"
                    id="pra_score" name="pra_score" required
                    placeholder="e.g., 85.5">
            </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary"
                            onclick="previousStage2()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-primary"
                            onclick="nextStage4()">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Stage 4: Review and Submit -->
                <div class="form-stage" id="stage-4">
                    <div class="stage-header">
                        <h3>Review Your Information</h3>
                        <p>Please review all the information you have entered
                            to ensure accuracy before submitting.</p>
                    </div>

                    <div class="review-container">
                        <div class="review-section">
                            <h4>Basic Demographics and Physical Attributes</h4>
                            <div class="review-grid">
                                <div class="review-item">
                                    <span class="review-label">Age:</span>
                                    <span class="review-value"
                                        id="review-age">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Gender:</span>
                                    <span class="review-value"
                                        id="review-gender">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Blood
                                        Type:</span>
                                    <span class="review-value"
                                        id="review-blood_type">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Rh Factor:</span>
                                    <span class="review-value"
                                        id="review-rh_factor">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Height:</span>
                                    <span class="review-value"
                                        id="review-height_cm">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Weight:</span>
                                    <span class="review-value"
                                        id="review-weight_kg">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">BMI:</span>
                                    <span class="review-value"
                                        id="review-bmi">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="review-section">
                            <h4>Medical History and Current Condition</h4>
                            <div class="review-grid">
                                <div class="review-item">
                                    <span class="review-label">Waitlist
                                        Days:</span>
                                    <span class="review-value"
                                        id="review-wait_list_days">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Medical Urgency
                                        Score:</span>
                                    <span class="review-value"
                                        id="review-medical_urgency_score">-</span>
                                </div>
                                <div class="review-item">
                                    <span
                                        class="review-label">Hemoglobin:</span>
                                    <span class="review-value"
                                        id="review-hemoglobin">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">WBC Count:</span>
                                    <span class="review-value"
                                        id="review-wbc_count">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Platelet
                                        Count:</span>
                                    <span class="review-value"
                                        id="review-platelet_count">-</span>
                                </div>
                                <div class="review-item">
                                    <span
                                        class="review-label">Creatinine:</span>
                                    <span class="review-value"
                                        id="review-creatinine">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">ALT:</span>
                                    <span class="review-value"
                                        id="review-alt">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">AST:</span>
                                    <span class="review-value"
                                        id="review-ast">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="review-section">
                            <h4>Transplant-Specific Information</h4>
                            <div class="review-grid">
                                <div class="review-item">
                                    <span class="review-label">Diabetes:</span>
                                    <span class="review-value"
                                        id="review-diabetes">-</span>
                                </div>
                                <div class="review-item">
                                    <span
                                        class="review-label">Hypertension:</span>
                                    <span class="review-value"
                                        id="review-hypertension">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Previous
                                        Transplant:</span>
                                    <span class="review-value"
                                        id="review-previous_transplant">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Dialysis
                                        Status:</span>
                                    <span class="review-value"
                                        id="review-dialysis_status">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Required
                                        Organ:</span>
                                    <span class="review-value"
                                        id="review-required_organ">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">Antibody
                                        Screen:</span>
                                    <span class="review-value"
                                        id="review-antibody_screen">-</span>
                                </div>
                                <div class="review-item">
                                    <span class="review-label">PRA Score:</span>
                                    <span class="review-value"
                                        id="review-pra_score">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary"
                            onclick="previousStage3()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="button" id="submit-btn" name="Submit"
                            class="btn btn-success" onclick="submitForm()">
                            Submit Assessment <i class="fas fa-paper-plane"></i>
                        </button>
            </div>
        </div>
    </form>
</div>
    </div>
</section>
{% endif %}

<script>
    // Debug: Log when script loads
    console.log('RecipientPrediction script loaded successfully');
    
    function nextStage() {
        document.getElementById('stage-1').classList.remove('active');
        document.getElementById('stage-2').classList.add('active');
        
        // Update progress steps
        document.querySelector('[data-step="1"]').classList.remove('active');
        document.querySelector('[data-step="2"]').classList.add('active');
    }

    function previousStage() {
        document.getElementById('stage-2').classList.remove('active');
        document.getElementById('stage-1').classList.add('active');
        
        // Update progress steps
        document.querySelector('[data-step="2"]').classList.remove('active');
        document.querySelector('[data-step="1"]').classList.add('active');
    }

    function nextStage2() {
        document.getElementById('stage-2').classList.remove('active');
        document.getElementById('stage-3').classList.add('active');
        
        // Update progress steps
        document.querySelector('[data-step="2"]').classList.remove('active');
        document.querySelector('[data-step="3"]').classList.add('active');
    }

    function previousStage2() {
        document.getElementById('stage-3').classList.remove('active');
        document.getElementById('stage-2').classList.add('active');
        
        // Update progress steps
        document.querySelector('[data-step="3"]').classList.remove('active');
        document.querySelector('[data-step="2"]').classList.add('active');
    }

    function nextStage4() {
        document.getElementById('stage-3').classList.remove('active');
        document.getElementById('stage-4').classList.add('active');
        
        // Update progress steps
        document.querySelector('[data-step="3"]').classList.remove('active');
        document.querySelector('[data-step="4"]').classList.add('active');
        
        // Populate review fields
        populateReview();
    }

    function previousStage3() {
        document.getElementById('stage-4').classList.remove('active');
        document.getElementById('stage-3').classList.add('active');
        
        // Update progress steps
        document.querySelector('[data-step="4"]').classList.remove('active');
        document.querySelector('[data-step="3"]').classList.add('active');
    }

    function populateReview() {
        // Basic Information
        document.getElementById('review-age').textContent = document.getElementById('age').value || 'Not provided';
        document.getElementById('review-gender').textContent = document.getElementById('gender').value || 'Not provided';
        document.getElementById('review-blood_type').textContent = document.getElementById('blood_type').value || 'Not provided';
        document.getElementById('review-rh_factor').textContent = document.getElementById('rh_factor').value || 'Not provided';
        document.getElementById('review-height_cm').textContent = (document.getElementById('height_cm').value || 'Not provided') + ' cm';
        document.getElementById('review-weight_kg').textContent = (document.getElementById('weight_kg').value || 'Not provided') + ' kg';
        document.getElementById('review-bmi').textContent = document.getElementById('bmi').value || 'Not provided';
        
        // Medical History and Current Condition
        document.getElementById('review-wait_list_days').textContent = (document.getElementById('wait_list_days').value || 'Not provided') + ' days';
        document.getElementById('review-medical_urgency_score').textContent = (document.getElementById('medical_urgency_score').value || 'Not provided') + '/10';
        document.getElementById('review-hemoglobin').textContent = (document.getElementById('hemoglobin').value || 'Not provided') + ' g/dL';
        document.getElementById('review-wbc_count').textContent = (document.getElementById('wbc_count').value || 'Not provided') + ' cells/µL';
        document.getElementById('review-platelet_count').textContent = (document.getElementById('platelet_count').value || 'Not provided') + ' cells/µL';
        document.getElementById('review-creatinine').textContent = (document.getElementById('creatinine').value || 'Not provided') + ' mg/dL';
        document.getElementById('review-alt').textContent = (document.getElementById('alt').value || 'Not provided') + ' U/L';
        document.getElementById('review-ast').textContent = (document.getElementById('ast').value || 'Not provided') + ' U/L';
        
        // Transplant-Specific Information
        document.getElementById('review-diabetes').textContent = document.getElementById('diabetes').value || 'Not provided';
        document.getElementById('review-hypertension').textContent = document.getElementById('hypertension').value || 'Not provided';
        document.getElementById('review-previous_transplant').textContent = document.getElementById('previous_transplant').value || 'Not provided';
        document.getElementById('review-dialysis_status').textContent = document.getElementById('dialysis_status').value || 'Not provided';
        document.getElementById('review-required_organ').textContent = document.getElementById('required_organ').value || 'Not provided';
        document.getElementById('review-antibody_screen').textContent = document.getElementById('antibody_screen').value || 'Not provided';
        document.getElementById('review-pra_score').textContent = (document.getElementById('pra_score').value || 'Not provided') + ' %';
    }

    // Submit form function
    function submitForm() {
        console.log('submitForm function called!');
        
        const form = document.getElementById('recipient-form');
        const requiredFields = form.querySelectorAll('input[required], select[required]');
    let allFilled = true;

        console.log('Checking required fields...');
    requiredFields.forEach(field => {
      const val = field.value.trim();
            console.log(`Field ${field.name}: "${val}"`);
            if (val === '' || val === 'Select...') {
        allFilled = false;
                field.classList.add('error');
                console.log(`Field ${field.name} is empty or invalid`);
      } else {
                field.classList.remove('error');
                console.log(`Field ${field.name} is valid`);
      }
    });

    if (!allFilled) {
            console.log('Validation failed - missing fields');
      Swal.fire({
        title: 'Missing Fields',
        text: 'Please fill in all required fields before submitting.',
        icon: 'warning',
        timer: 2000
      });
            return false;
        }

        console.log('Validation passed, starting submission...');

        // Show loading state
        Swal.fire({
            title: 'Submitting Assessment...',
            text: 'Please wait while we process your compatibility assessment',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Collect form data
        const formData = new FormData(form);
        
        // Debug: Log form data
        console.log('Form data collected:');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        // Send form data to recipientprictiction function
        const url = '{% url "recipientprictiction" %}';
        console.log('Sending fetch request to:', url);
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log('Response received:', response);
            console.log('Response status:', response.status);
            console.log('Response redirected:', response.redirected);
            console.log('Response url:', response.url);
            
            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Check if we got redirected (which means success)
            if (response.redirected) {
                console.log('Response was redirected, following redirect...');
                window.location.href = response.url;
                return null; // Don't process text content
            }
            
            // Get the response text first
            return response.text();
        })
        .then(html => {
            // If html is null, we already redirected
            if (html === null) {
                console.log('Already redirected, skipping further processing');
                return;
            }
            
            console.log('HTML response received, length:', html.length);
            console.log('First 200 chars of response:', html.substring(0, 200));
            console.log('Response contains "Recipient":', html.includes('Recipient'));
            console.log('Response contains "Result":', html.includes('Result'));
            console.log('Response contains "Compatibility":', html.includes('Compatibility'));
            
            // Since data was saved successfully, redirect to result page
            console.log('Form submitted successfully, redirecting to result page...');
            
            // Show success message first
            Swal.fire({
                title: 'Assessment Submitted!',
                text: 'Your recipient compatibility assessment has been processed successfully!',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                // Redirect to the result page
                console.log('Redirecting to result page...');
                window.location.href = '{% url "RecipientResultpage" %}';
            });
        })
        .catch(error => {
            console.error('Fetch error:', error);
                Swal.fire({
                title: 'Submission Error',
                text: 'There was an error submitting your assessment. Please try again.',
                icon: 'error',
                    confirmButtonText: 'OK'
                });
        });
        
        return false;
    }

    // Form validation and submission (backup)
    document.getElementById('recipient-form').addEventListener('submit', function(e) {
        console.log('Form submit event triggered!');
        e.preventDefault(); // Prevent default form submission
        e.stopPropagation(); // Stop event bubbling
        console.log('Default submission prevented');
        
        // Call the submitForm function instead
        submitForm();
        
        return false; // Ensure form doesn't submit
    });
    
    // Debug: Ensure everything is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        console.log('Form element:', document.getElementById('recipient-form'));
        console.log('Submit button:', document.getElementById('submit-btn'));
        
        // Double-check form submission prevention
        const form = document.getElementById('recipient-form');
        if (form) {
            console.log('Form found, adding additional submit prevention');
            form.onsubmit = function(e) {
                console.log('Form onsubmit triggered');
                e.preventDefault();
                e.stopPropagation();
                return false;
            };
        }
    });
</script>
{% endblock %}
