{% extends 'base.html' %}
{% load static %}

{% block title %}
Recipient Compatibility Result - LifeChain
{% endblock title %}

{% block breadcrumb %}
<section class="breadcrumb-section">
    <div class="container">
        <nav class="breadcrumb-nav">
            <div class="breadcrumb-item">
                <a href="{% url 'index' %}" class="breadcrumb-link">
                    <i class="fas fa-home"></i>
                    Home
                </a>
            </div>
            <div class="breadcrumb-item">
                <a href="{% url 'recipientpage' %}" class="breadcrumb-link">
                    <i class="fas fa-search"></i>
                    Recipient
                </a>
            </div>
            <div class="breadcrumb-item">
                <span class="breadcrumb-current">Compatibility Result</span>
            </div>
        </nav>
    </div>
</section>
{% endblock breadcrumb %}

{% block content %}
<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}

<style>
/* Report Styles */
.report-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.logo-section {
    margin-bottom: 1.5rem;
}

.logo-text {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin: 0;
    text-shadow: 2px 2px 4px var(--shadow-color);
}

.tagline {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin: 0.5rem 0 0 0;
    font-style: italic;
}

.report-title h2 {
    font-size: 1.8rem;
    color: var(--text-primary);
    margin: 0 0 0.5rem 0;
    font-weight: 600;
}

.generation-info {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin: 0;
}

.compatibility-section {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.compatibility-section h3 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
    font-weight: 600;
}

.result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.result-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.result-label {
    font-weight: 600;
    color: var(--text-secondary);
}

.result-value {
    font-weight: 500;
    color: var(--text-primary);
}

.eligibility-status {
    text-align: center;
    margin-top: 1rem;
}

.status-badge {
    display: inline-block;
    padding: 0.5rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.status-badge.eligible {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: 2px solid #059669;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.status-badge.not-eligible {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: 2px solid #dc2626;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.medical-report {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.medical-report h3 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
    font-weight: 600;
        text-align: center;
    }

.report-section {
    margin-bottom: 2rem;
}

.report-section:last-child {
    margin-bottom: 0;
}

.report-section h4 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1.2rem;
    font-weight: 600;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--primary-color);
}

.report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.report-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.report-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.report-label {
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 120px;
}

.report-value {
    font-weight: 500;
    color: var(--text-primary);
    text-align: right;
    max-width: 150px;
    word-wrap: break-word;
}

/* Responsive Design */
@media (max-width: 768px) {
    .report-header,
    .compatibility-section,
    .medical-report {
        margin: 1rem;
        padding: 1rem;
    }
    
    .result-grid,
    .report-grid {
        grid-template-columns: 1fr;
    }
    
    .report-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .report-value {
        text-align: left;
        max-width: none;
    }
}

@media (max-width: 480px) {
    .logo-text {
        font-size: 2rem;
    }
    
    .report-title h2 {
        font-size: 1.5rem;
    }
    
    .compatibility-section h3,
    .medical-report h3 {
        font-size: 1.2rem;
    }
    }
</style>

<!-- Add user data attributes -->
<div id="user-data"
    data-user-id="{{ user.id }}"
    data-user-contact="{{ user.contact|default:'N/A' }}"
    data-user-email="{{ user.email|default:'N/A' }}"
    data-user-address="{{ user.address|default:'N/A' }}"
    style="display: none;">
</div>

<!-- Skeleton Loading -->
<div id="skeleton-loading" class="skeleton-container">
    <div class="skeleton-header">
        <div class="skeleton-logo"></div>
        <div class="skeleton-title"></div>
    </div>

    <div class="skeleton-content">
        <div class="skeleton-section">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>

        <div class="skeleton-section">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>

        <div class="skeleton-section">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>
    </div>
</div>

<<!-- Actual Content -->
<div id="actual-content" style="display: none;">
    <!-- Header Section -->
    <div class="report-header">
        <div class="logo-section">
            <h1 class="logo-text">LifeChain</h1>
            <p class="tagline">Organ Donation & Transplantation System</p>
        </div>

        <div class="report-title">
            <h2>Recipient Compatibility Assessment Report</h2>
            <p class="generation-info">
                Generated on:
                {% if record.created_at %}
                    {{ record.created_at|date:"F d, Y" }}
                {% else %}
                    Recently completed
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Compatibility Assessment -->
    <div class="compatibility-section">
        <h3>Compatibility Assessment</h3>
        <div class="result-grid">
            <div class="result-item">
                <span class="result-label">Compatibility Score:</span>
                <span class="result-value">
                    {% if record.compatibility_score %}
                        {{ record.compatibility_score }}%
                    {% else %}
                        N/A
                    {% endif %}
                </span>
            </div>

            <div class="result-item">
                <span class="result-label">Assessment Date:</span>
                <span class="result-value">
                    {% if record.created_at %}
                        {{ record.created_at|date:"F d, Y" }}
                    {% else %}
                        Recently completed
                    {% endif %}
                </span>
            </div>

            <div class="result-item">
                <span class="result-label">Required Organ:</span>
                <span class="result-value">{{ record.required_organ|default:"N/A" }}</span>
            </div>

            <div class="result-item">
                <span class="result-label">Priority Level:</span>
                <span class="result-value">
                    {% if record.medical_urgency_score and record.medical_urgency_score > 7 %}
                        High
                    {% else %}
                        Standard
                {% endif %}
                </span>
            </div>
        </div>

        <div class="eligibility-status">
            <!-- Debug: Actual value: {{ record.transplant_eligibility }} -->
            <span class="status-badge 
                {% if record.transplant_eligibility|lower == 'eligible' %}
                    eligible
                {% elif record.transplant_eligibility|lower == 'not eligible' or record.transplant_eligibility|lower == 'noteligible' %}
                    not-eligible
                {% else %}
                    unknown
                {% endif %}
            ">
                {% if record.transplant_eligibility %}
                    {{ record.transplant_eligibility }}
                {% else %}
                    Not Available
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Detailed Medical Report -->
    <div class="medical-report">
        <h3>Detailed Medical Report</h3>

        <!-- Patient Demographics -->
        <div class="report-section">
            <h4>Patient Demographics</h4>
            <div class="report-grid">
                <div class="report-item">
                    <span class="report-label">Patient Name:</span>
                    <span class="report-value">{{ user.username|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Age:</span>
                    <span class="report-value">{{ record.age|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Gender:</span>
                    <span class="report-value">
                        {% if record.gender == 1 %}
                            Male
                        {% elif record.gender == 0 %}
                            Female
                        {% else %}
                            N/A
                {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">Blood Type:</span>
                    <span class="report-value">
                        {% if record.blood_type == 0 %}
                            A
                        {% elif record.blood_type == 1 %}
                            B
                        {% elif record.blood_type == 2 %}
                            AB
                        {% elif record.blood_type == 3 %}
                            O
                        {% else %}
                            N/A
                {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">Rh Factor:</span>
                    <span class="report-value">
                        {% if record.rh_factor == 1 %}
                            +
                        {% elif record.rh_factor == 0 %}
                            -
                        {% else %}
                            N/A
                {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">Height (cm):</span>
                    <span class="report-value">{{ record.height_cm|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Weight (kg):</span>
                    <span class="report-value">{{ record.weight_kg|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">BMI:</span>
                    <span class="report-value">{{ record.bmi|default:"N/A" }}</span>
                </div>
            </div>
        </div>

        <!-- Wait List & Urgency -->
        <div class="report-section">
            <h4>Wait List & Urgency</h4>
            <div class="report-grid">
                <div class="report-item">
                    <span class="report-label">Wait List Days:</span>
                    <span class="report-value">{{ record.wait_list_days|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Medical Urgency Score:</span>
                    <span class="report-value">{{ record.medical_urgency_score|default:"N/A" }}</span>
                </div>
            </div>
        </div>

        <!-- Laboratory Values -->
        <div class="report-section">
            <h4>Laboratory Values</h4>
            <div class="report-grid">
                <div class="report-item">
                    <span class="report-label">Hemoglobin (g/dL):</span>
                    <span class="report-value">{{ record.hemoglobin|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">WBC Count (cells/µL):</span>
                    <span class="report-value">{{ record.wbc_count|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Platelet Count (cells/µL):</span>
                    <span class="report-value">{{ record.platelet_count|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Creatinine (mg/dL):</span>
                    <span class="report-value">{{ record.creatinine|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">ALT (U/L):</span>
                    <span class="report-value">{{ record.alt|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">AST (U/L):</span>
                    <span class="report-value">{{ record.ast|default:"N/A" }}</span>
                </div>
            </div>
        </div>

        <!-- Medical History -->
        <div class="report-section">
            <h4>Medical History</h4>
            <div class="report-grid">
                <div class="report-item">
                    <span class="report-label">Diabetes:</span>
                    <span class="report-value">
                        {% if record.diabetes == 1 %}
                            Yes
                        {% elif record.diabetes == 0 %}
                            No
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">Hypertension:</span>
                    <span class="report-value">
                        {% if record.hypertension == 1 %}
                            Yes
                        {% elif record.hypertension == 0 %}
                            No
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">Previous Transplant:</span>
                    <span class="report-value">
                        {% if record.previous_transplant == 1 %}
                            Yes
                        {% elif record.previous_transplant == 0 %}
                            No
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">Dialysis Status:</span>
                    <span class="report-value">
                        {% if record.dialysis_status == 1 %}
                            Yes
                        {% elif record.dialysis_status == 0 %}
                            No
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Transplant Specific -->
        <div class="report-section">
            <h4>Transplant Specific</h4>
            <div class="report-grid">
                <div class="report-item">
                    <span class="report-label">Required Organ:</span>
                    <span class="report-value">{{ record.required_organ|default:"N/A" }}</span>
                </div>
                <div class="report-item">
                    <span class="report-label">Antibody Screen:</span>
                    <span class="report-value">
                        {% if record.antibody_screen == 1 %}
                            Positive
                        {% elif record.antibody_screen == 0 %}
                            Negative
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="report-item">
                    <span class="report-label">PRA Score (%):</span>
                    <span class="report-value">{{ record.pra_score|default:"N/A" }}</span>
                </div>
            </div>
        </div>


    </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button id="download-btn" class="btn btn-primary"
            onclick="downloadPDF()">
            <i class="fas fa-download"></i> Download Report
        </button>
    </div>
</div>

<script>
// Show skeleton loading initially
document.addEventListener('DOMContentLoaded', function() {
    // Simulate loading delay
    setTimeout(() => {
        document.getElementById('skeleton-loading').style.display = 'none';
        document.getElementById('actual-content').style.display = 'block';
    }, 1500);
});

// Download PDF function
function downloadPDF() {
    // Check if jsPDF is available
    if (typeof window.jspdf === 'undefined') {
        console.error('jsPDF not loaded');
        Swal.fire({
            title: 'Error!',
            text: 'PDF generation library not loaded. Please refresh the page and try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }

    // Check if content is visible, if not wait for it
    const actualContent = document.getElementById('actual-content');
    if (actualContent.style.display === 'none') {
        console.log('Content not visible yet, waiting...');
        // Wait for content to be visible
        setTimeout(() => {
            downloadPDF();
        }, 100);
        return;
    }

    console.log('jsPDF loaded successfully:', window.jspdf);

    // Show loading state
    Swal.fire({
        title: 'Generating PDF...',
        text: 'Please wait while we prepare your report',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        // Generate PDF immediately
        generateAndDownloadPDF();
        
        // Hide loading and show success
        Swal.fire({
            title: 'PDF Generated!',
            text: 'Your report has been downloaded successfully.',
            icon: 'success',
            confirmButtonText: 'Great!'
        }).then((result) => {
            // After PDF download, show eligibility popup
            showEligibilityPopup();
        });
    } catch (error) {
        console.error('PDF generation error:', error);
        
        // Fallback: Generate simple text-based PDF
        try {
            generateSimplePDF();
            
                Swal.fire({
                title: 'PDF Generated!',
                text: 'Your report has been downloaded successfully (simple format).',
                    icon: 'success',
                confirmButtonText: 'Great!'
            }).then((result) => {
                // After PDF download, show eligibility popup
                showEligibilityPopup();
            });
        } catch (fallbackError) {
            console.error('Fallback PDF generation failed:', fallbackError);
                Swal.fire({
                title: 'Error!',
                text: 'Failed to generate PDF. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
            });
        }
    }
}

// Show eligibility popup after PDF download
function showEligibilityPopup() {
    const isEligible = document.querySelector('.status-badge.eligible') !== null;
    
    if (isEligible) {
        if (window.isAlreadyDonor) {
            // User is eligible but already a donor - show thank you message
            Swal.fire({
                title: 'Thank You! 🎉',
                text: 'You are eligible for organ transplantation and you are already registered as a donor. Thank you for your generosity!',
                icon: 'success',
                confirmButtonText: 'See Available Donors',
                confirmButtonColor: '#10b981'
            }).then((result) => {
                // Redirect to eligible donors page
                window.location.href = '{% url "eligibleDdonors" %}';
            });
        } else {
            // User is eligible and not a donor - show donor option
            Swal.fire({
                title: 'Congratulations! 🎉',
                text: 'You are eligible for organ transplantation! Would you like to see available donors?',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'Yes, Show Donors',
                cancelButtonText: 'No, Go Home',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Redirect to eligible donors page
                    window.location.href = '{% url "eligibleDdonors" %}';
                } else {
                    // Redirect to home page
                    window.location.href = '{% url "index" %}';
                }
            });
        }
    } else {
        // User is not eligible - redirect to home
        Swal.fire({
            title: 'Assessment Complete',
            text: 'Your compatibility assessment has been completed. Redirecting to home page.',
            icon: 'info',
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            window.location.href = '{% url "index" %}';
        });
    }
}

// Helper function to find values by their label text
function findValueByLabel(labelText) {
    // Find all report-label elements
    const labels = document.querySelectorAll('.report-label');
    
    for (let label of labels) {
        if (label.textContent.trim() === labelText) {
            // Find the corresponding value element
            const valueElement = label.parentElement.querySelector('.report-value');
            if (valueElement) {
                return valueElement.textContent.trim();
            }
        }
    }
    
    // Fallback: try to find by partial text match
    for (let label of labels) {
        if (label.textContent.includes(labelText.replace(':', ''))) {
            const valueElement = label.parentElement.querySelector('.report-value');
            if (valueElement) {
                return valueElement.textContent.trim();
            }
        }
    }
    
    return 'N/A';
}

// Generate and download PDF function
function generateAndDownloadPDF() {
    console.log('Starting PDF generation...');
    console.log('window.jspdf:', window.jspdf);
    
    const { jsPDF } = window.jspdf;
    console.log('jsPDF constructor:', jsPDF);
    
    const doc = new jsPDF();
    console.log('PDF document created:', doc);
    
    // Set document properties
    doc.setProperties({
        title: 'Recipient Compatibility Report',
        subject: 'Medical Assessment Report',
        author: 'LifeChain Organ Donation System',
        creator: 'LifeChain'
    });
    
    // Page dimensions
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    let yPosition = margin;
    
    // Add LifeChain Logo (text-based logo)
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(59, 130, 246);
    doc.text('LifeChain', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 12;
    
    // Add tagline
    doc.setFontSize(10);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(107, 114, 128);
    doc.text('Organ Donation & Transplantation System', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Add separator line
    doc.setDrawColor(59, 130, 246);
    doc.setLineWidth(0.5);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 15;
    
    // Add report title
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 0, 0);
    doc.text('RECIPIENT COMPATIBILITY ASSESSMENT REPORT', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 20;
    
    // Add generation date and time
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(107, 114, 128);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, margin, yPosition);
    doc.text(`Generated at: ${new Date().toLocaleTimeString()}`, pageWidth - margin, yPosition, { align: 'right' });
    yPosition += 15;
    
    // Get report data using a more robust approach - find elements by their label text
    const reportData = {
        // Patient Demographics - find by label text
        patientName: findValueByLabel('Patient Name:') || 'N/A',
        age: findValueByLabel('Age:') || 'N/A',
        gender: findValueByLabel('Gender:') || 'N/A',
        bloodType: findValueByLabel('Blood Type:') || 'N/A',
        rhFactor: findValueByLabel('Rh Factor:') || 'N/A',
        height: findValueByLabel('Height (cm):') || 'N/A',
        weight: findValueByLabel('Weight (kg):') || 'N/A',
        bmi: findValueByLabel('BMI:') || 'N/A',
        
        // Compatibility Section
        compatibilityScore: getTextContent('.compatibility-section .result-grid .result-item:nth-child(1) .result-value') || 'N/A',
        eligibility: getTextContent('.status-badge') || 'N/A',
        assessmentDate: getTextContent('.compatibility-section .result-grid .result-item:nth-child(2) .result-value') || 'N/A',
        requiredOrgan: getTextContent('.compatibility-section .result-grid .result-item:nth-child(3) .result-value') || 'N/A',
        priorityLevel: getTextContent('.compatibility-section .result-grid .result-item:nth-child(4) .result-value') || 'N/A'
    };
    
    // Debug: Log what elements are found for Patient Demographics
    console.log('Debug - Patient Demographics elements:');
    console.log('Section found:', document.querySelector('.medical-report .report-section:first-child'));
    console.log('Grid found:', document.querySelector('.medical-report .report-section:first-child .report-grid'));
    console.log('First item found:', document.querySelector('.medical-report .report-section:first-child .report-grid .report-item:first-child'));
    console.log('First value found:', document.querySelector('.medical-report .report-section:first-child .report-grid .report-item:first-child .report-value'));
    
    // Test alternative selector
    console.log('Alternative selector test:', document.querySelector('.report-section:first-child .report-grid .report-item:first-child .report-value'));
    console.log('Direct test:', document.querySelector('.report-item .report-value'));
    
    // Ensure content is visible before proceeding
    if (!document.querySelector('.medical-report')) {
        console.error('Medical report section not found! Content may not be visible yet.');
        return;
    }
    
    // Log the extracted data for debugging
    console.log('Extracted report data:', reportData);
    
    // Create a clean, organized layout
    yPosition = addCleanSection(doc, 'PATIENT INFORMATION & COMPATIBILITY', yPosition, pageWidth, margin, [
        ['Patient Name:', reportData.patientName, 'Eligibility Status:', reportData.eligibility],
        ['Age:', reportData.age, 'Compatibility Score:', reportData.compatibilityScore],
        ['Gender:', reportData.gender, 'Assessment Date:', reportData.assessmentDate],
        ['Blood Type:', reportData.bloodType, 'Required Organ:', reportData.requiredOrgan],
        ['Rh Factor:', reportData.rhFactor, 'Priority Level:', reportData.priorityLevel],
        ['Height:', reportData.height, '', ''],
        ['Weight:', reportData.weight, '', ''],
        ['BMI:', reportData.bmi, '', '']
    ]);
    
    yPosition += 10;
    
    // Add wait list and urgency
    yPosition = addCleanSection(doc, 'WAIT LIST & URGENCY', yPosition, pageWidth, margin, [
        ['Wait List Days:', findValueByLabel('Wait List Days:') || 'N/A', 'Medical Urgency Score:', findValueByLabel('Medical Urgency Score:') || 'N/A']
    ]);
    
    yPosition += 10;
    
    // Add laboratory values
    yPosition = addCleanSection(doc, 'LABORATORY VALUES', yPosition, pageWidth, margin, [
        ['Hemoglobin:', findValueByLabel('Hemoglobin (g/dL):') || 'N/A', 'WBC Count:', findValueByLabel('WBC Count (cells/µL):') || 'N/A'],
        ['Platelet Count:', findValueByLabel('Platelet Count (cells/µL):') || 'N/A', 'Creatinine:', findValueByLabel('Creatinine (mg/dL):') || 'N/A'],
        ['ALT:', findValueByLabel('ALT (U/L):') || 'N/A', 'AST:', findValueByLabel('AST (U/L):') || 'N/A']
    ]);
    
    yPosition += 10;
    
    // Add medical history
    yPosition = addCleanSection(doc, 'MEDICAL HISTORY', yPosition, pageWidth, margin, [
        ['Diabetes:', findValueByLabel('Diabetes:') || 'N/A', 'Hypertension:', findValueByLabel('Hypertension:') || 'N/A'],
        ['Previous Transplant:', findValueByLabel('Previous Transplant:') || 'N/A', 'Dialysis Status:', findValueByLabel('Dialysis Status:') || 'N/A']
    ]);
    
    yPosition += 10;
    
    // Add transplant specific
    yPosition = addCleanSection(doc, 'TRANSPLANT SPECIFIC', yPosition, pageWidth, margin, [
        ['Required Organ:', findValueByLabel('Required Organ:') || 'N/A', 'Antibody Screen:', findValueByLabel('Antibody Screen:') || 'N/A'],
        ['PRA Score:', findValueByLabel('PRA Score (%):') || 'N/A', '', '']
    ]);
    
    yPosition += 15;
    
    // Add footer
    addCleanFooter(doc, pageWidth, pageHeight, margin);
    
    // Save the PDF
    const fileName = `LifeChain_Recipient_Report_${reportData.patientName}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
}

// Fallback simple PDF generation function
function generateSimplePDF() {
    console.log('Using fallback PDF generation...');
    
    // Create a simple text-based report
    let reportContent = 'LifeChain Organ Donation & Transplantation System\n';
    reportContent += 'RECIPIENT COMPATIBILITY ASSESSMENT REPORT\n';
    reportContent += 'Generated on: ' + new Date().toLocaleDateString() + '\n';
    reportContent += 'Generated at: ' + new Date().toLocaleTimeString() + '\n\n';
    
    // Add basic information
    reportContent += 'PATIENT INFORMATION:\n';
    reportContent += 'Patient Name: ' + (document.querySelector('.report-section:nth-child(1) .report-item:nth-child(1) .report-value')?.textContent?.trim() || 'N/A') + '\n';
    reportContent += 'Age: ' + (document.querySelector('.report-section:nth-child(1) .report-item:nth-child(2) .report-value')?.textContent?.trim() || 'N/A') + '\n';
    reportContent += 'Gender: ' + (document.querySelector('.report-section:nth-child(1) .report-item:nth-child(3) .report-value')?.textContent?.trim() || 'N/A') + '\n';
    reportContent += 'Blood Type: ' + (document.querySelector('.report-section:nth-child(1) .report-item:nth-child(4) .report-value')?.textContent?.trim() || 'N/A') + '\n';
    reportContent += 'Eligibility: ' + (document.querySelector('.status-badge')?.textContent?.trim() || 'N/A') + '\n';
    
    // Create and download the text file
    const blob = new Blob([reportContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'LifeChain_Recipient_Report.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Helper function to get clean text content
function getTextContent(selector) {
    const element = document.querySelector(selector);
    if (!element) {
        console.log(`Element not found for selector: ${selector}`);
        return 'N/A';
    }
    
    let text = element.textContent.trim();
    
    // Clean up the text - remove extra whitespace and newlines
    text = text.replace(/\s+/g, ' ').trim();
    
    // Handle specific cases
    if (text === '') return 'N/A';
    if (text === 'undefined') return 'N/A';
    if (text === 'null') return 'N/A';
    
    console.log(`Extracted text from ${selector}: "${text}"`);
    return text;
}

// Helper function to add clean sections with proper alignment
function addCleanSection(doc, title, yPosition, pageWidth, margin, data) {
    // Check if we need a new page
    if (yPosition > 270) {
        doc.addPage();
        yPosition = 15;
    }
    
    // Add section header
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(59, 130, 246);
    doc.text(title, margin, yPosition);
    yPosition += 6;
    
    // Add underline
    doc.setDrawColor(59, 130, 246);
    doc.setLineWidth(0.3);
    doc.line(margin, yPosition, margin + 80, yPosition);
    yPosition += 8;
    
    // Add data in clean format
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    
    data.forEach(row => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = 15;
        }
        
        // Left column
        if (row[0] && row[1]) {
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(75, 85, 99);
            doc.text(row[0], margin, yPosition);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(row[1], margin + 45, yPosition);
        }
        
        // Right column
        if (row[2] && row[3]) {
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(75, 85, 99);
            doc.text(row[2], pageWidth / 2 + 15, yPosition);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(row[3], pageWidth / 2 + 55, yPosition);
        }
        
        yPosition += 6; // Slightly increased for better readability
    });
    
    return yPosition;
}

// Helper function to add clean footer
function addCleanFooter(doc, pageWidth, pageHeight, margin) {
    const footerY = pageHeight - 20;
    
    // Add separator line
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.3);
    doc.line(margin, footerY, pageWidth - margin, footerY);
    
    // Add footer text
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(107, 114, 128);
    doc.text('Generated by LifeChain Organ Donation System', pageWidth / 2, footerY + 4, { align: 'center' });
    doc.text('Contact: LifeChain_Team@uskt.edu.pk | Address: University of Sialkot, Main Daska Road, Sialkot, Pakistan', pageWidth / 2, footerY + 9, { align: 'center' });
    doc.text('For medical use only - Please consult healthcare professionals', pageWidth / 2, footerY + 14, { align: 'center' });
}

</script>

<script>
// Set global variables for JavaScript use
window.isAlreadyDonor = {% if is_already_donor %}true{% else %}false{% endif %};
</script>

{% endblock content %}
